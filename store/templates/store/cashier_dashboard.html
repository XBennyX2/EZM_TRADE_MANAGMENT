{% extends 'base.html' %}
{% load store_extras %}
{% block title %}Cashier Dashboard{% endblock %}

{% block content %}
<div class="container mt-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">Cashier Dashboard</h2>
          <p class="text-muted mb-0">Welcome, {{ request.user.first_name|default:request.user.username }}! | Store: {{ store.name }}</p>
        </div>
        <div>
          <button class="btn btn-primary btn-lg" onclick="startNewSale()">
            <i class="bi bi-plus-circle me-2"></i>New Sale
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="row">
    <!-- Available Products by Batch -->
    <div class="col-lg-8">
      {% if products_by_batch %}
        {% for batch_name, products in products_by_batch.items %}
        <div class="card mb-4">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
              <i class="bi bi-box me-2"></i>Batch: {{ batch_name }}
            </h5>
            <span class="badge bg-primary">{{ products|length }} items</span>
          </div>
          <div class="card-body">
            <div class="row">
              {% for stock in products %}
              <div class="col-md-6 col-lg-4 mb-3">
                <div class="card h-100 product-card" data-product-id="{{ stock.product.id }}" data-stock-id="{{ stock.id }}">
                  <div class="card-body">
                    <h6 class="card-title">{{ stock.product.name }}</h6>
                    <p class="card-text">
                      <small class="text-muted">{{ stock.product.category }}</small><br>
                      {% if stock.product.expiry_date %}
                        <small class="text-muted">
                          Expires: {{ stock.product.expiry_date|date:"M d, Y" }}
                        </small><br>
                      {% endif %}
                      <strong>Price: ${{ stock.selling_price }}</strong><br>
                      <span class="badge {% if stock.quantity <= stock.low_stock_threshold %}bg-warning{% else %}bg-success{% endif %}">
                        Stock: {{ stock.quantity }}
                      </span>
                    </p>
                    <button class="btn btn-sm btn-outline-primary select-product-btn"
                            data-product-id="{{ stock.product.id }}"
                            data-product-name="{{ stock.product.name }}"
                            data-price="{{ stock.selling_price }}"
                            data-available-stock="{{ stock.quantity }}"
                            data-batch="{{ stock.product.batch_number|default:'No Batch' }}">
                      <i class="bi bi-cart-plus me-1"></i>Select
                    </button>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="bi bi-box-seam fa-3x text-muted mb-3"></i>
          <h4>No products available</h4>
          <p class="text-muted">
            No products are currently available for sale in your store.
          </p>

          {% if debug_stats %}
          <div class="alert alert-info text-start">
            <strong>Store Inventory Status:</strong><br>
            • Total stock items in store: {{ debug_stats.total_stock_items }}<br>
            • Available for sale: {{ debug_stats.available_products_count }}<br>
            • Out of stock: {{ debug_stats.out_of_stock_items }}<br>
            • Expired items: {{ debug_stats.expired_items }}
          </div>
          {% endif %}

          <p class="text-muted">
            {% if debug_stats.total_stock_items == 0 %}
              <strong>No stock items found.</strong> Your store manager needs to add products to inventory.
            {% elif debug_stats.out_of_stock_items == debug_stats.total_stock_items %}
              <strong>All items are out of stock.</strong> Your store manager needs to restock inventory.
            {% elif debug_stats.expired_items > 0 %}
              <strong>Some items may have expired.</strong> Contact your store manager to review inventory.
            {% else %}
              <strong>Contact your store manager</strong> to review inventory status.
            {% endif %}
          </p>
          <p class="text-muted">
            <strong>Contact your store manager</strong> to add products to inventory or restock existing items.
          </p>


        </div>
      </div>
      {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Quick Actions -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">Quick Actions</h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button class="btn btn-primary" onclick="startNewSale()">
              <i class="bi bi-plus-circle me-2"></i>New Sale
            </button>
            <a href="{% url 'cashier_settings' %}" class="btn btn-outline-secondary">
              <i class="bi bi-gear me-2"></i>Settings
            </a>
          </div>
        </div>
      </div>

      <!-- Recent Transactions -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">Recent Sales</h5>
        </div>
        <div class="card-body">
          {% if recent_transactions %}
          <div class="list-group list-group-flush">
            {% for transaction in recent_transactions %}
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <h6 class="mb-1">#{{ transaction.id }}</h6>
                <small class="text-muted">{{ transaction.timestamp|date:"M d, H:i" }}</small>
              </div>
              <span class="badge bg-success">${{ transaction.total_amount }}</span>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted text-center">No recent transactions</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Sale Modal -->
<div class="modal fade" id="saleModal" tabindex="-1" aria-labelledby="saleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="saleModalLabel">Process Sale</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="saleForm">
          {% csrf_token %}
          <!-- Selected Product Info -->
          <div id="selectedProductInfo" class="alert alert-info" style="display: none;">
            <h6 id="selectedProductName"></h6>
            <p class="mb-1">Price: $<span id="selectedProductPrice"></span></p>
            <p class="mb-0">Available Stock: <span id="selectedProductStock"></span></p>
          </div>

          <!-- Quantity Input -->
          <div class="mb-3">
            <label for="quantity" class="form-label">Quantity</label>
            <input type="number" class="form-control" id="quantity" name="quantity" min="1" required>
          </div>

          <!-- Customer Information -->
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="customerName" class="form-label">Customer Name</label>
                <input type="text" class="form-control" id="customerName" name="customer_name" required
                       pattern="[A-Za-z\s]+" title="Name should only contain letters and spaces"
                       placeholder="Enter customer's full name">
                <div class="invalid-feedback">
                  Name should only contain letters and spaces.
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="customerPhone" class="form-label">Customer Phone</label>
                <input type="tel" class="form-control" id="customerPhone" name="customer_phone" required
                       pattern="[\+]?[0-9\s\-\(\)]+" title="Phone should only contain numbers, +, spaces, hyphens, and parentheses"
                       placeholder="e.g., +1234567890 or 0912345678">
                <div class="invalid-feedback">
                  Phone should only contain numbers and + symbol.
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Type -->
          <div class="mb-3">
            <label for="paymentType" class="form-label">Payment Type</label>
            <select class="form-select" id="paymentType" name="payment_type" required>
              <option value="cash">Cash</option>
              <option value="mobile">Mobile Banking</option>
              <option value="bank">Bank Transfer</option>
            </select>
          </div>

          <!-- Total Display -->
          <div class="alert alert-success">
            <h5>Total: $<span id="totalAmount">0.00</span></h5>
          </div>

          <input type="hidden" id="selectedProductId" name="product_id">
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="processSale()">Process Sale</button>
      </div>
    </div>
  </div>
</div>

<!-- Receipt Options Modal -->
<div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="receiptModalLabel">Receipt Options</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Sale completed successfully! Choose how to provide the receipt:</p>
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-primary" onclick="printReceipt()">
            <i class="bi bi-printer me-2"></i>Print Receipt
          </button>
          <button type="button" class="btn btn-outline-primary" onclick="showEmailForm()">
            <i class="bi bi-envelope me-2"></i>Email Receipt
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="finishSale()">Skip</button>
      </div>
    </div>
  </div>
</div>

<!-- Email Receipt Modal -->
<div class="modal fade" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="emailModalLabel">Email Receipt</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="emailForm">
          <div class="mb-3">
            <label for="customerEmail" class="form-label">Customer Email Address</label>
            <input type="email" class="form-control" id="customerEmail" name="customer_email" required
                   placeholder="Enter customer's email address">
            <div class="form-text">The receipt will be sent to this email address as a PDF attachment.</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="sendEmailReceipt()">
          <i class="bi bi-send me-2"></i>Send Receipt
        </button>
      </div>
    </div>
  </div>
</div>

<script>
let selectedProduct = null;
let lastReceiptId = null;

// Show validation error
function showValidationError(fieldId, message) {
    const field = document.getElementById(fieldId);
    const feedback = field.parentNode.querySelector('.invalid-feedback');

    field.classList.add('is-invalid');
    if (feedback) {
        feedback.textContent = message;
    }

    // Remove error styling after user starts typing
    field.addEventListener('input', function() {
        field.classList.remove('is-invalid');
    }, { once: true });
}

// Start new sale - show modal to select product first
function startNewSale() {
    // Check if there are products available
    if (document.querySelectorAll('.select-product-btn').length === 0) {
        alert('No products available for sale. Contact your store manager.');
        return;
    }

    // Show instruction to select a product
    alert('Please select a product from the list below to start a sale.');
}

// Handle product selection
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.select-product-btn').forEach(button => {
        button.addEventListener('click', function() {
            selectedProduct = {
                id: this.dataset.productId,
                name: this.dataset.productName,
                price: parseFloat(this.dataset.price),
                stock: parseInt(this.dataset.availableStock),
                batch: this.dataset.batch
            };

            // Show sale modal
            showSaleModal();
        });
    });

    // Add real-time validation
    const customerNameField = document.getElementById('customerName');
    const customerPhoneField = document.getElementById('customerPhone');

    if (customerNameField) {
        customerNameField.addEventListener('input', function() {
            const value = this.value;
            const namePattern = /^[A-Za-z\s]*$/; // Allow empty for partial input

            if (value && !namePattern.test(value)) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }

    if (customerPhoneField) {
        customerPhoneField.addEventListener('input', function() {
            const value = this.value;
            const phonePattern = /^[\+]?[0-9\s\-\(\)]*$/; // Allow empty for partial input

            if (value && !phonePattern.test(value)) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }
});

function showSaleModal() {
    if (!selectedProduct) return;

    // Populate product info
    document.getElementById('selectedProductName').textContent = selectedProduct.name;
    document.getElementById('selectedProductPrice').textContent = selectedProduct.price.toFixed(2);
    document.getElementById('selectedProductStock').textContent = selectedProduct.stock;
    document.getElementById('selectedProductId').value = selectedProduct.id;

    // Set max quantity
    document.getElementById('quantity').max = selectedProduct.stock;
    document.getElementById('quantity').value = 1;

    // Show product info and calculate initial total
    document.getElementById('selectedProductInfo').style.display = 'block';
    updateTotal();

    // Show modal
    new bootstrap.Modal(document.getElementById('saleModal')).show();
}

// Update total when quantity changes
document.getElementById('quantity').addEventListener('input', updateTotal);

function updateTotal() {
    if (!selectedProduct) return;

    const quantity = parseInt(document.getElementById('quantity').value) || 0;
    const total = selectedProduct.price * quantity;
    document.getElementById('totalAmount').textContent = total.toFixed(2);
}

// Process the sale
function processSale() {
    const form = document.getElementById('saleForm');
    const formData = new FormData(form);

    // Custom validation
    const customerName = formData.get('customer_name').trim();
    const customerPhone = formData.get('customer_phone').trim();
    const quantity = parseInt(formData.get('quantity'));

    // Validate customer name (only letters and spaces)
    const namePattern = /^[A-Za-z\s]+$/;
    if (!namePattern.test(customerName)) {
        showValidationError('customerName', 'Customer name should only contain letters and spaces.');
        return;
    }

    // Validate phone number (only numbers, +, spaces, hyphens, parentheses)
    const phonePattern = /^[\+]?[0-9\s\-\(\)]+$/;
    if (!phonePattern.test(customerPhone)) {
        showValidationError('customerPhone', 'Phone number should only contain numbers, +, spaces, hyphens, and parentheses.');
        return;
    }

    // Validate form using HTML5 validation
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Check quantity
    if (quantity > selectedProduct.stock) {
        alert(`Only ${selectedProduct.stock} items available in stock.`);
        return;
    }

    // Show loading
    const processBtn = document.querySelector('#saleModal .btn-primary');
    processBtn.disabled = true;
    processBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';

    // Submit sale (we'll create this endpoint)
    fetch('/stores/process-single-sale/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            lastReceiptId = data.receipt_id;
            // Hide sale modal
            bootstrap.Modal.getInstance(document.getElementById('saleModal')).hide();
            // Show receipt options
            new bootstrap.Modal(document.getElementById('receiptModal')).show();
        } else {
            alert('Error: ' + (data.error || 'Failed to process sale'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while processing the sale.');
    })
    .finally(() => {
        // Reset button
        processBtn.disabled = false;
        processBtn.innerHTML = 'Process Sale';
    });
}

// Print receipt
function printReceipt() {
    if (lastReceiptId) {
        window.open('/stores/receipt/' + lastReceiptId + '/pdf/', '_blank');
    }
    finishSale();
}

// Show email form
function showEmailForm() {
    // Hide receipt options modal
    bootstrap.Modal.getInstance(document.getElementById('receiptModal')).hide();
    // Show email modal
    new bootstrap.Modal(document.getElementById('emailModal')).show();
}

// Send email receipt
function sendEmailReceipt() {
    const emailForm = document.getElementById('emailForm');
    const customerEmail = document.getElementById('customerEmail').value.trim();

    // Validate email
    if (!emailForm.checkValidity()) {
        emailForm.reportValidity();
        return;
    }

    if (!customerEmail) {
        alert('Please enter a valid email address.');
        return;
    }

    if (lastReceiptId) {
        // Show loading state
        const sendBtn = document.querySelector('#emailModal .btn-primary');
        const originalText = sendBtn.innerHTML;
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';

        fetch('/stores/receipt/' + lastReceiptId + '/email/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({email: customerEmail})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="bi bi-check-circle me-2"></i>
                    Receipt sent successfully to ${customerEmail}!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('#emailModal .modal-body').prepend(alertDiv);

                // Auto-close after 2 seconds
                setTimeout(() => {
                    bootstrap.Modal.getInstance(document.getElementById('emailModal')).hide();
                    finishSale();
                }, 2000);
            } else {
                // Show error message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Failed to send receipt: ${data.error || 'Unknown error'}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('#emailModal .modal-body').prepend(alertDiv);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle me-2"></i>
                An error occurred while sending the receipt.
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('#emailModal .modal-body').prepend(alertDiv);
        })
        .finally(() => {
            // Reset button
            sendBtn.disabled = false;
            sendBtn.innerHTML = originalText;
        });
    }
}

// Finish sale and refresh page
function finishSale() {
    // Hide any open modals
    const receiptModal = bootstrap.Modal.getInstance(document.getElementById('receiptModal'));
    const emailModal = bootstrap.Modal.getInstance(document.getElementById('emailModal'));

    if (receiptModal) receiptModal.hide();
    if (emailModal) emailModal.hide();

    selectedProduct = null;
    lastReceiptId = null;

    // Reset forms
    document.getElementById('saleForm').reset();
    document.getElementById('selectedProductInfo').style.display = 'none';
    document.getElementById('emailForm').reset();

    // Remove any alert messages from email modal
    const alerts = document.querySelectorAll('#emailModal .alert');
    alerts.forEach(alert => alert.remove());

    // Refresh page to update stock levels
    setTimeout(() => {
        location.reload();
    }, 1000);
}

// Reset email form when modal is hidden
document.getElementById('emailModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('emailForm').reset();
    // Remove any alert messages
    const alerts = document.querySelectorAll('#emailModal .alert');
    alerts.forEach(alert => alert.remove());
});
</script>

{% endblock %}
