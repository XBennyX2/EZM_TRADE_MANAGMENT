{% extends 'base_sidebar.html' %}
{% load static %}
{% block title %}Order - {{ store.name }}{% endblock %}
{% block page_title %}Order{% endblock %}
{% block sidebar_menu %}
{% include 'sidebar_navigation.html' %}
{% endblock %}
{% block content %}

<div class="container-fluid">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="ezm-card">
        <div class="ezm-card-header d-flex justify-content-between align-items-center">
          <div>
            <h3 class="mb-1 text-white">
              <i class="bi bi-cart-plus me-2" style="color: #66FCF1;"></i>Point of Sale
            </h3>
            <p class="mb-0" style="color: #C5C6C7;">Store: {{ store.name }} | Salesperson: {{ request.user.first_name }}</p>
          </div>
          <div>
            <a href="{% url 'ticket_management' %}" class="btn btn-ezm-secondary btn-sm">
              <i class="bi bi-ticket-perforated me-1"></i>Customer Tickets
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>



  <div class="row">
    <!-- Product Selection -->
    <div class="col-lg-8">
      <div class="ezm-card">
        <div class="ezm-card-header">
          <h5 class="mb-0 text-white">
            <i class="bi bi-grid-3x3-gap me-2" style="color: #66FCF1;"></i>Select Products
          </h5>
        </div>
        <div class="card-body" style="background-color: #1F2833;">
          <!-- Search Bar -->
          <div class="mb-4">
            <div class="input-group">
              <span class="input-group-text" style="background-color: #45A29E; border-color: #45A29E; color: white;">
                <i class="bi bi-search"></i>
              </span>
              <input type="text" class="form-control" id="productSearch" placeholder="Search products..."
                style="border-color: #45A29E; background-color: #0B0C10; color: #C5C6C7;">
            </div>
          </div>

          <!-- Product Grid -->
          <div class="row" id="productGrid">
            {% for product in available_products %}
            <div class="col-md-6 col-xl-4 mb-3 product-item" data-name="{{ product.product__name|lower }}">
              <div class="ezm-card h-100 product-card" style="cursor: pointer; transition: all 0.3s ease;"
                data-product-id="{{ product.product__id }}" data-product-name="{{ product.product__name }}"
                data-price="{{ product.selling_price }}" data-stock="{{ product.quantity }}">
                <div class="card-body text-center" style="background-color: #0B0C10;">
                  <div class="mb-3">
                    <i class="bi bi-box-seam fs-1" style="color: #66FCF1;"></i>
                  </div>
                  <h6 class="card-title text-white mb-2">{{ product.product__name }}</h6>
                  <div class="mb-3">
                    <div class="badge mb-2" style="background-color: #45A29E; font-size: 0.9rem;">
                      ETB {{ product.selling_price }}
                    </div>
                    <br>
                    <small style="color: #C5C6C7;">Stock: {{ product.quantity }} units</small>
                  </div>
                  <button class="btn btn-ezm-primary btn-sm add-to-cart-btn w-100">
                    <i class="bi bi-cart-plus me-1"></i>Add to Cart
                  </button>
                </div>
              </div>
            </div>
            {% empty %}
            <div class="col-12">
              <div class="text-center py-5">
                <i class="bi bi-box fs-1" style="color: #C5C6C7;"></i>
                <p class="mt-3" style="color: #C5C6C7;">No products available in stock</p>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>

    <!-- Shopping Cart -->
    <div class="col-lg-4">
      <div class="ezm-card sticky-top" style="top: 20px; z-index: 100;">
        <div class="ezm-card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0 text-white">
            <i class="bi bi-cart3 me-2" style="color: #66FCF1;"></i>Shopping Cart
          </h5>
          <button class="btn btn-sm" id="clearCart"
            style="background-color: #dc3545; border-color: #dc3545; color: white;">
            <i class="bi bi-trash"></i>
          </button>
        </div>
        <div class="card-body" style="background-color: #1F2833;">
          <div id="cartItems" style="min-height: 120px;">
            <!-- Cart items will be populated here -->
            <div class="text-center py-4">
              <i class="bi bi-cart-x fs-2" style="color: #C5C6C7;"></i>
              <p class="mt-2 mb-0" style="color: #C5C6C7;">Cart is empty</p>
            </div>
          </div>

          <hr style="border-color: #45A29E;">

          <!-- Order Summary -->
          <div class="mb-4">
            <div class="d-flex justify-content-between mb-2" style="color: #C5C6C7;">
              <span>Subtotal:</span>
              <span id="subtotal" style="color: #66FCF1;">ETB 0.00</span>
            </div>
            <div class="d-flex justify-content-between mb-2" style="color: #C5C6C7;">
              <span>Tax (15%):</span>
              <span id="taxAmount" style="color: #66FCF1;">ETB 0.00</span>
            </div>
            <hr style="border-color: #45A29E;">
            <div class="d-flex justify-content-between fw-bold" style="color: #66FCF1; font-size: 1.1rem;">
              <span>Total:</span>
              <span id="totalAmount">ETB 0.00</span>
            </div>
          </div>

          <!-- Order Options -->
          <div class="mb-3">
            <label for="customerName" class="form-label" style="color: #C5C6C7;">Customer Name</label>
            <input type="text" class="form-control" id="customerName" placeholder="Walk-in Customer"
              value="{{ ticket_info.customer_name|default:'Walk-in Customer' }}" pattern="[A-Za-z\s\-']+"
              title="Only letters, spaces, hyphens, and apostrophes are allowed"
              style="background-color: #0B0C10; border-color: #45A29E; color: #C5C6C7;">
            <div class="invalid-feedback" id="customerNameError" style="display: none; color: #dc3545;">
              Please enter a valid name (letters only)
            </div>
          </div>

          <div class="mb-3">
            <label for="customerPhone" class="form-label" style="color: #C5C6C7;">Customer Phone (Optional)</label>
            <input type="tel" class="form-control" id="customerPhone" placeholder="0911234567 or +251911234567"
              value="{{ ticket_info.customer_phone|default:'' }}" pattern="^(\+251|251|0)?[79]\d{8}$"
              title="Enter a valid Ethiopian phone number"
              style="background-color: #0B0C10; border-color: #45A29E; color: #C5C6C7;">
            <div class="invalid-feedback" id="customerPhoneError" style="display: none; color: #dc3545;">
              Please enter a valid Ethiopian phone number
            </div>
          </div>

          <div class="mb-3">
            <label for="paymentType" class="form-label" style="color: #C5C6C7;">Payment Method</label>
            <select class="form-select" id="paymentType"
              style="background-color: #0B0C10; border-color: #45A29E; color: #C5C6C7;">
              <option value="cash">Cash</option>
              <option value="mobile">Mobile Banking</option>
              <option value="bank">Bank Transfer</option>
            </select>
          </div>



          <!-- Action Buttons -->
          <div class="d-grid gap-2">
            <button class="btn btn-ezm-primary" id="completeOrder" disabled>
              <i class="bi bi-check-circle me-2"></i>Complete Order
            </button>
            <button class="btn btn-ezm-secondary" id="saveForLater">
              <i class="bi bi-bookmark me-2"></i>Save for Later
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden input for cart data -->
<input type="hidden" id="cartData" value="{{ cart|default:'{}'|escapejs }}">

<!-- Order Success Modal -->
<div class="modal fade" id="orderSuccessModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content" style="background-color: #1F2833; border: 1px solid #45A29E;">
      <div class="modal-header" style="background-color: #45A29E; border-bottom: 1px solid #66FCF1;">
        <h5 class="modal-title text-white">
          <i class="bi bi-check-circle me-2"></i>Order Completed Successfully!
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="background-color: #1F2833;">
        <div class="text-center mb-4">
          <i class="bi bi-receipt fs-1" style="color: #66FCF1;"></i>
          <h4 class="mt-2 text-white">Receipt #<span id="receiptNumber" style="color: #66FCF1;"></span></h4>
          <p style="color: #C5C6C7;">Total: ETB <span id="orderTotal" style="color: #66FCF1;"></span></p>
        </div>

        <div class="row">
          <div class="col-md-6">
            <div class="ezm-card">
              <div class="card-body text-center" style="background-color: #0B0C10;">
                <i class="bi bi-download fs-2" style="color: #66FCF1;"></i>
                <h6 class="mt-2 text-white">Download Receipt</h6>
                <p class="small" style="color: #C5C6C7;">Get a PDF copy of the receipt</p>
                <button class="btn btn-ezm-primary" id="downloadReceiptBtn">
                  <i class="bi bi-download me-2"></i>Download PDF
                </button>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="ezm-card">
              <div class="card-body text-center" style="background-color: #0B0C10;">
                <i class="bi bi-envelope fs-2" style="color: #45A29E;"></i>
                <h6 class="mt-2 text-white">Email Receipt</h6>
                <p class="small" style="color: #C5C6C7;">Send receipt to customer's email</p>
                <button class="btn btn-ezm-secondary" id="emailReceiptBtn">
                  <i class="bi bi-envelope me-2"></i>Email Receipt
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="background-color: #1F2833; border-top: 1px solid #45A29E;">
        <button type="button" class="btn btn-ezm-primary" id="newOrderBtn">
          <i class="bi bi-plus-circle me-2"></i>Order
        </button>
        <button type="button" class="btn btn-ezm-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Email Receipt Modal -->
<div class="modal fade" id="emailModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content" style="background-color: #1F2833; border: 1px solid #45A29E;">
      <div class="modal-header" style="background-color: #0B0C10; border-bottom: 1px solid #45A29E;">
        <h5 class="modal-title text-white">
          <i class="bi bi-envelope me-2" style="color: #66FCF1;"></i>Email Receipt
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="background-color: #1F2833;">
        <div class="mb-3">
          <label for="customerEmail" class="form-label" style="color: #C5C6C7;">Customer Email Address</label>
          <input type="email" class="form-control" id="customerEmail" placeholder="customer@example.com" required
            style="background-color: #0B0C10; border-color: #45A29E; color: #C5C6C7;">
          <div class="form-text" style="color: #C5C6C7;">Enter the customer's email address to send the receipt</div>
        </div>
        <div id="emailStatus" class="alert" style="display: none;"></div>
      </div>
      <div class="modal-footer" style="background-color: #1F2833; border-top: 1px solid #45A29E;">
        <button type="button" class="btn btn-ezm-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-ezm-primary" id="sendEmailBtn">
          <i class="bi bi-send me-2"></i>Send Receipt
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Quantity Modal -->
<div class="modal fade" id="quantityModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content" style="background-color: #1F2833; border: 1px solid #45A29E;">
      <div class="modal-header" style="background-color: #0B0C10; border-bottom: 1px solid #45A29E;">
        <h5 class="modal-title text-white">
          <i class="bi bi-plus-circle me-2" style="color: #66FCF1;"></i>Select Quantity
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" style="background-color: #1F2833;">
        <div class="mb-3">
          <label for="quantityInput" class="form-label" style="color: #C5C6C7;">Quantity</label>
          <input type="number" class="form-control" id="quantityInput" min="1" value="1"
            style="background-color: #0B0C10; border-color: #45A29E; color: #C5C6C7;">
          <small style="color: #C5C6C7;">Available: <span id="availableStock" style="color: #66FCF1;"></span>
            units</small>
        </div>
      </div>
      <div class="modal-footer" style="background-color: #1F2833; border-top: 1px solid #45A29E;">
        <button type="button" class="btn btn-ezm-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-ezm-primary" id="confirmAddToCart">
          <i class="bi bi-cart-plus me-2"></i>Add to Cart
        </button>
      </div>
    </div>
  </div>
</div>

<style>
  /* EZM Theme Variables */
  :root {
    --ezm-dark: #0B0C10;
    --ezm-dark-blue: #1F2833;
    --ezm-light-gray: #C5C6C7;
    --ezm-cyan: #66FCF1;
    --ezm-teal: #45A29E;
  }

  /* Product Card Hover Effects */
  .product-card {
    border: 1px solid var(--ezm-teal);
    transition: all 0.3s ease;
    background: linear-gradient(135deg, var(--ezm-dark) 0%, var(--ezm-dark-blue) 100%);
  }

  .product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(102, 252, 241, 0.2);
    border-color: var(--ezm-cyan);
    background: linear-gradient(135deg, var(--ezm-dark-blue) 0%, var(--ezm-dark) 100%);
  }

  .product-card:hover .btn-ezm-primary {
    background: linear-gradient(135deg, var(--ezm-cyan) 0%, var(--ezm-teal) 100%);
    transform: scale(1.05);
  }

  /* Cart Item Styling */
  .cart-item {
    border-bottom: 1px solid var(--ezm-teal);
    padding: 15px 0;
    background: linear-gradient(90deg, transparent 0%, rgba(102, 252, 241, 0.05) 50%, transparent 100%);
    border-radius: 8px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
  }

  .cart-item:hover {
    background: linear-gradient(90deg, rgba(69, 162, 158, 0.1) 0%, rgba(102, 252, 241, 0.1) 50%, rgba(69, 162, 158, 0.1) 100%);
    transform: translateX(5px);
  }

  .cart-item:last-child {
    border-bottom: none;
  }

  /* Search Input Focus Effect */
  #productSearch:focus {
    border-color: var(--ezm-cyan);
    box-shadow: 0 0 0 0.2rem rgba(102, 252, 241, 0.25);
    background-color: var(--ezm-dark-blue);
  }

  /* Form Input Focus Effects */
  .form-control:focus,
  .form-select:focus {
    border-color: var(--ezm-cyan) !important;
    box-shadow: 0 0 0 0.2rem rgba(102, 252, 241, 0.25) !important;
  }

  /* Sticky Cart Animation */
  .sticky-top {
    animation: slideInRight 0.5s ease-out;
  }

  @keyframes slideInRight {
    from {
      transform: translateX(100%);
      opacity: 0;
    }

    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* Product Grid Animation */
  .product-item {
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
  }

  .product-item:nth-child(1) {
    animation-delay: 0.1s;
  }

  .product-item:nth-child(2) {
    animation-delay: 0.2s;
  }

  .product-item:nth-child(3) {
    animation-delay: 0.3s;
  }

  .product-item:nth-child(4) {
    animation-delay: 0.4s;
  }

  .product-item:nth-child(5) {
    animation-delay: 0.5s;
  }

  .product-item:nth-child(6) {
    animation-delay: 0.6s;
  }

  @keyframes fadeInUp {
    from {
      transform: translateY(30px);
      opacity: 0;
    }

    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Button Hover Effects */
  .btn-ezm-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(102, 252, 241, 0.4);
  }

  .btn-ezm-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(69, 162, 158, 0.4);
  }

  /* Modal Backdrop */
  .modal-backdrop {
    background-color: rgba(11, 12, 16, 0.8);
  }

  /* Scrollbar Styling */
  ::-webkit-scrollbar {
    width: 8px;
  }

  ::-webkit-scrollbar-track {
    background: var(--ezm-dark);
  }

  ::-webkit-scrollbar-thumb {
    background: var(--ezm-teal);
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: var(--ezm-cyan);
  }

  /* Loading Animation for Buttons */
  .btn-loading {
    position: relative;
    color: transparent !important;
  }

  .btn-loading::after {
    content: "";
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid transparent;
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  /* Sidebar Layout Adjustments */
  .main-content {
    background: linear-gradient(135deg, #0B0C10 0%, #1F2833 100%) !important;
    min-height: 100vh;
  }

  .content-area {
    background: transparent;
  }

  /* Ticket Card Styling */
  .ticket-card {
    border: 1px solid var(--ezm-teal);
    transition: all 0.3s ease;
    background: linear-gradient(135deg, var(--ezm-dark) 0%, var(--ezm-dark-blue) 100%);
  }

  .ticket-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(102, 252, 241, 0.15);
    border-color: var(--ezm-cyan);
  }

  .ticket-info {
    font-size: 0.9rem;
  }

  .items-preview {
    background: rgba(69, 162, 158, 0.1);
    border-radius: 6px;
    padding: 8px;
  }

  /* Tickets section toggle animation */
  #tickets-section {
    transition: all 0.3s ease;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .container-fluid {
      padding-left: 15px;
      padding-right: 15px;
    }

    .product-card {
      margin-bottom: 20px;
    }

    .sticky-top {
      position: relative !important;
      top: auto !important;
      margin-top: 30px;
    }

    .ticket-card {
      margin-bottom: 15px;
    }
  }

  /* Ensure proper spacing with sidebar */
  @media (min-width: 769px) {
    .container-fluid {
      padding-left: 20px;
      padding-right: 20px;
    }
  }
</style>

<script>
  // Cart management
  let selectedProduct = null;
  let cart;
  try {
    const cartDataElement = document.getElementById('cartData');
    const cartDataValue = cartDataElement ? cartDataElement.value : '{}';
    console.log('DEBUG: Raw cart data from server:', cartDataValue);
    cart = JSON.parse(cartDataValue || '{}');
    console.log('DEBUG: Parsed cart data:', cart);
    if (!cart.items) cart.items = [];
    if (!cart.total) cart.total = 0;
    console.log('DEBUG: Final cart structure:', cart);
  } catch (error) {
    console.error('Error parsing cart data:', error);
    cart = { items: [], total: 0 };
  }
  let currentTicketNumber = null; // Track if this order is from a ticket

  // Load cart data from localStorage
  function loadCartFromLocalStorage() {
    try {
      const cartData = localStorage.getItem('pos_cart_data');
      const customerInfo = localStorage.getItem('pos_customer_info');

      if (cartData) {
        console.log('DEBUG: Loading cart from localStorage');
        const parsedCartData = JSON.parse(cartData);

        // Update cart with localStorage data
        cart = {
          items: parsedCartData.items || [],
          total: parsedCartData.total || 0
        };

        console.log('DEBUG: Cart loaded from localStorage:', cart);

        // Load customer information if available
        if (customerInfo) {
          const parsedCustomerInfo = JSON.parse(customerInfo);
          const customerNameField = document.getElementById('customerName');
          const customerPhoneField = document.getElementById('customerPhone');

          if (customerNameField && parsedCustomerInfo.name) {
            customerNameField.value = parsedCustomerInfo.name;
          }
          if (customerPhoneField && parsedCustomerInfo.phone) {
            customerPhoneField.value = parsedCustomerInfo.phone;
          }
        }

        // Set ticket info if this cart is from a ticket
        if (parsedCartData.from_ticket && parsedCartData.ticket_info) {
          currentTicketNumber = parsedCartData.ticket_info.ticket_number;

          // Update page header to show ticket info
          const headerElement = document.querySelector('.ezm-card-header h3');
          if (headerElement) {
            headerElement.innerHTML = `
              <i class="bi bi-ticket-perforated me-2" style="color: #66FCF1;"></i>
              Processing Ticket #${parsedCartData.ticket_info.ticket_number}
            `;
          }

          // Save ticket info to session for Django
          saveTicketInfoToSession(parsedCartData.ticket_info);

          // Show notification
          showNotification(`Ticket #${parsedCartData.ticket_info.ticket_number} loaded successfully! ${cart.items.length} items in cart.`, 'success');
        }

        // Save cart to Django session immediately
        saveCartToSession();

        // Clear localStorage after loading (single use)
        localStorage.removeItem('pos_cart_data');
        localStorage.removeItem('pos_customer_info');

        return true; // Indicate that cart was loaded from localStorage
      }
    } catch (error) {
      console.error('Error loading cart from localStorage:', error);
      showNotification('Error loading cart data', 'error');
    }

    return false; // No cart data in localStorage
  }

  // Initialize
  document.addEventListener('DOMContentLoaded', function () {
    console.log('DEBUG: DOM loaded, initializing cart display');
    // Load cart data from localStorage first
    loadCartFromLocalStorage();
    // Check if we have ticket data to load (legacy support)
    loadTicketDataIfExists();
    // Always update cart display on page load
    updateCartDisplay();
    updateTotals();
    attachEventListeners();
  });

  // Load ticket data from sessionStorage if it exists
  function loadTicketDataIfExists() {
    const ticketData = sessionStorage.getItem('ticketCartData');
    if (ticketData) {
      try {
        const data = JSON.parse(ticketData);

        // Show notification that we're loading order
        showNotification('Loading order items', 'info');

        // Clear existing cart
        cart = { items: [], total: 0 };

        // Add each item from ticket to cart
        data.items.forEach(item => {
          // Find the product card to get stock information
          const productCard = document.querySelector(`[data-product-id="${item.product_id}"]`);
          if (productCard) {
            const stock = parseInt(productCard.dataset.stock);

            // Check if we have enough stock
            if (stock >= item.quantity) {
              // Add item to cart
              const cartItem = {
                id: item.product_id,
                name: item.product_name,
                price: item.price,
                quantity: item.quantity,
                total: item.price * item.quantity
              };

              cart.items.push(cartItem);
              cart.total += cartItem.total;
            } else {
              showNotification(`Insufficient stock for ${item.product_name}. Available: ${stock}, Required: ${item.quantity}`, 'warning');
            }
          } else {
            showNotification(`Product ${item.product_name} not found in current store`, 'warning');
          }
        });

        // Fill customer information if provided
        if (data.customer_name) {
          const customerNameField = document.getElementById('customerName');
          if (customerNameField) {
            customerNameField.value = data.customer_name;
          }
        }

        if (data.customer_phone) {
          const customerPhoneField = document.getElementById('customerPhone');
          if (customerPhoneField) {
            customerPhoneField.value = data.customer_phone;
          }
        }

        // Update header to show we're processing an order
        const headerElement = document.querySelector('h3');
        if (headerElement) {
          headerElement.innerHTML = `<i class="bi bi-cart-plus me-2" style="color: #66FCF1;"></i>Order`;
        }

        // Clear the sessionStorage data
        sessionStorage.removeItem('ticketCartData');

        // Update cart display
        updateCartDisplay();

      } catch (error) {
        console.error('Error loading ticket data:', error);
        showNotification('Error loading ticket data', 'error');
        sessionStorage.removeItem('ticketCartData');
      }
    }
  }

  // Show notification function
  function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'success'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Add to page
    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 5000);
  }

  // Get CSRF token from cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Update ticket status
  async function updateTicketStatus(ticketNumber, status) {
    try {
      // Ensure fetch is available and properly scoped
      const fetchFunction = window.fetch || fetch;
      if (!fetchFunction) {
        console.error('Fetch API not available');
        showNotification('Browser does not support required features', 'error');
        return;
      }

      const response = await fetchFunction(`/stores/api/tickets/${ticketNumber}/status/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          status: status
        })
      });

      const data = await response.json();

      if (data.success) {
        showNotification(`Ticket #${ticketNumber} status updated to ${status}`, 'success');
      } else {
        console.error('Failed to update ticket status:', data.error);
        showNotification(`Warning: Failed to update ticket status`, 'warning');
      }
    } catch (error) {
      console.error('Error updating ticket status:', error);
      showNotification(`Warning: Could not update ticket status`, 'warning');
    }
  }

  // Product search
  document.getElementById('productSearch').addEventListener('input', function (e) {
    const searchTerm = e.target.value.toLowerCase();
    const productItems = document.querySelectorAll('.product-item');

    productItems.forEach(item => {
      const productName = item.dataset.name;
      if (productName.includes(searchTerm)) {
        item.style.display = 'block';
      } else {
        item.style.display = 'none';
      }
    });
  });

  // Add to cart functionality
  function attachEventListeners() {
    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
      btn.addEventListener('click', function (e) {
        e.stopPropagation();
        const card = this.closest('.product-card');
        selectedProduct = {
          id: card.dataset.productId,
          name: card.dataset.productName,
          price: parseFloat(card.dataset.price),
          stock: parseInt(card.dataset.stock)
        };

        document.getElementById('availableStock').textContent = selectedProduct.stock;
        document.getElementById('quantityInput').max = selectedProduct.stock;
        document.getElementById('quantityInput').value = 1;

        new bootstrap.Modal(document.getElementById('quantityModal')).show();
      });
    });
  }

  // Confirm add to cart
  document.getElementById('confirmAddToCart').addEventListener('click', function () {
    const quantity = parseInt(document.getElementById('quantityInput').value);

    if (quantity > selectedProduct.stock) {
      alert('Quantity exceeds available stock');
      return;
    }

    addToCart(selectedProduct.id, quantity);
    bootstrap.Modal.getInstance(document.getElementById('quantityModal')).hide();
  });

  // Add to cart API call
  function addToCart(productId, quantity) {
    console.log('Adding to cart:', { productId, quantity }); // Debug log

    // Use XMLHttpRequest as a fallback to avoid fetch context issues
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '{% url "add_to_cart" %}', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        try {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            console.log('Response data:', data); // Debug log
            if (data.success) {
              cart = data.cart;
              updateCartDisplay();
              showNotification(data.message, 'success');
            } else {
              showNotification(data.error || 'Unknown error occurred', 'error');
            }
          } else {
            console.error('HTTP error! status:', xhr.status);
            showNotification(`Error adding to cart: HTTP ${xhr.status}`, 'error');
          }
        } catch (error) {
          console.error('Response parsing error:', error);
          showNotification('Error processing server response', 'error');
        }
      }
    };

    xhr.onerror = function () {
      console.error('Network error');
      showNotification('Network error. Please check your connection.', 'error');
    };

    try {
      xhr.send(JSON.stringify({
        product_id: productId,
        quantity: quantity
      }));
    } catch (error) {
      console.error('Request send error:', error);
      showNotification('Error sending request: ' + error.message, 'error');
    }
  }


  // Update cart display
  function updateCartDisplay() {
    console.log('DEBUG: updateCartDisplay called with cart:', cart);
    const cartItems = document.getElementById('cartItems');
    cartItems.innerHTML = '';

    if (cart.items && cart.items.length > 0) {
      console.log('DEBUG: Displaying', cart.items.length, 'cart items');
      cart.items.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'cart-item';
        itemDiv.style.animationDelay = `${index * 0.1}s`;
        itemDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 text-white">${item.product_name}</h6>
                        <small style="color: #C5C6C7;">ETB ${(item.price || 0)} x ${item.quantity}</small>
                    </div>
                    <div class="text-end">
                        <div class="mb-2" style="color: #66FCF1; font-weight: bold;">ETB ${(item.subtotal || item.total_price || (item.price * item.quantity) || 0).toFixed(2)}</div>
                        <button class="btn btn-sm" onclick="removeFromCart(${item.product_id})"
                                style="background-color: #dc3545; border-color: #dc3545; color: white;"
                                onmouseover="this.style.backgroundColor='#c82333'"
                                onmouseout="this.style.backgroundColor='#dc3545'">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        cartItems.appendChild(itemDiv);
      });

      document.getElementById('completeOrder').disabled = false;
    } else {
      console.log('DEBUG: Cart is empty or has no items');
      cartItems.innerHTML = `
        <div class="text-center py-4">
          <i class="bi bi-cart-x fs-2" style="color: #C5C6C7;"></i>
          <p class="mt-2 mb-0" style="color: #C5C6C7;">Cart is empty</p>
        </div>
      `;
      document.getElementById('completeOrder').disabled = true;
    }

    updateTotals();
  }

  // Update totals
  function updateTotals() {
    // Calculate subtotal from cart items if cart.total is not available or incorrect
    let subtotal = 0;
    if (cart.items && cart.items.length > 0) {
      subtotal = cart.items.reduce((sum, item) => {
        const itemTotal = item.subtotal || item.total_price || (item.price * item.quantity) || 0;
        return sum + parseFloat(itemTotal);
      }, 0);
    }

    // Use calculated subtotal or fallback to cart.total
    subtotal = subtotal || cart.total || 0;

    const taxAmount = subtotal * 0.15; // Always apply 15% tax
    const total = subtotal + taxAmount;

    console.log('DEBUG: updateTotals - subtotal:', subtotal, 'tax:', taxAmount, 'total:', total);

    document.getElementById('subtotal').textContent = `ETB ${subtotal.toFixed(2)}`;
    document.getElementById('taxAmount').textContent = `ETB ${taxAmount.toFixed(2)}`;
    document.getElementById('totalAmount').textContent = `ETB ${total.toFixed(2)}`;
  }

  // Event listeners for total updates
  // No discount field to listen to anymore

  // Customer name validation (only letters, spaces, hyphens, apostrophes)
  document.getElementById('customerName').addEventListener('input', function (e) {
    const value = e.target.value;
    const namePattern = /^[A-Za-z\s\-']*$/;
    const errorDiv = document.getElementById('customerNameError');

    if (value && !namePattern.test(value)) {
      e.target.classList.add('is-invalid');
      errorDiv.style.display = 'block';
      // Remove invalid characters
      e.target.value = value.replace(/[^A-Za-z\s\-']/g, '');
    } else {
      e.target.classList.remove('is-invalid');
      errorDiv.style.display = 'none';
    }
  });

  // Customer phone validation (only numbers and specific format)
  document.getElementById('customerPhone').addEventListener('input', function (e) {
    const value = e.target.value;
    const phonePattern = /^(\+251|251|0)?[79]\d{0,8}$/;
    const errorDiv = document.getElementById('customerPhoneError');

    // Allow only numbers, +, and specific prefixes
    const cleanValue = value.replace(/[^\d+]/g, '');

    if (cleanValue !== value) {
      e.target.value = cleanValue;
    }

    if (cleanValue && !phonePattern.test(cleanValue)) {
      e.target.classList.add('is-invalid');
      errorDiv.style.display = 'block';
    } else {
      e.target.classList.remove('is-invalid');
      errorDiv.style.display = 'none';
    }
  });

  // Validate phone number format on blur
  document.getElementById('customerPhone').addEventListener('blur', function (e) {
    const value = e.target.value.trim();
    const fullPhonePattern = /^(\+251|251|0)?[79]\d{8}$/;
    const errorDiv = document.getElementById('customerPhoneError');

    if (value && !fullPhonePattern.test(value)) {
      e.target.classList.add('is-invalid');
      errorDiv.style.display = 'block';
      errorDiv.textContent = 'Please enter a complete Ethiopian phone number (e.g., 0911234567)';
    } else {
      e.target.classList.remove('is-invalid');
      errorDiv.style.display = 'none';
    }
  });



  // Unified notification function
  function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    const alertType = type === 'error' ? 'danger' : type === 'warning' ? 'warning' : type === 'info' ? 'info' : 'success';
    notification.className = `alert alert-${alertType} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Add to page
    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 5000);
  }

  // Alias for backward compatibility
  function showToast(message, type) {
    showNotification(message, type);
  }

  // Remove from cart
  function removeFromCart(productId) {
    // Use XMLHttpRequest to avoid fetch context issues
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '{% url "remove_from_cart" %}', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        try {
          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            if (data.success) {
              cart = data.cart;
              updateCartDisplay();
              showNotification(data.message, 'success');
            } else {
              showNotification(data.error || 'Error removing item', 'error');
            }
          } else {
            console.error('HTTP error! status:', xhr.status);
            showNotification(`Error removing item: HTTP ${xhr.status}`, 'error');
          }
        } catch (error) {
          console.error('Response parsing error:', error);
          showNotification('Error processing server response', 'error');
        }
      }
    };

    xhr.onerror = function () {
      console.error('Network error');
      showNotification('Network error. Please check your connection.', 'error');
    };

    try {
      xhr.send(JSON.stringify({
        product_id: productId
      }));
    } catch (error) {
      console.error('Request send error:', error);
      showNotification('Error sending request: ' + error.message, 'error');
    }
  }


  // Complete order
  document.getElementById('completeOrder').addEventListener('click', function () {
    console.log('Complete order button clicked'); // Debug log
    console.log('Current cart:', cart); // Debug log

    // Save cart to session one more time before completing order
    const cartSaved = saveCartToSession();
    if (!cartSaved) {
      showNotification('Error saving cart data. Please try again.', 'error');
      return;
    }

    // Validate customer data before proceeding
    const customerName = document.getElementById('customerName').value.trim();
    const customerPhone = document.getElementById('customerPhone').value.trim();

    // Validate customer name
    const namePattern = /^[A-Za-z\s\-']+$/;
    if (customerName && !namePattern.test(customerName)) {
      showNotification('Please enter a valid customer name (letters only)', 'error');
      document.getElementById('customerName').focus();
      return;
    }

    // Validate customer phone if provided
    const phonePattern = /^(\+251|251|0)?[79]\d{8}$/;
    if (customerPhone && !phonePattern.test(customerPhone)) {
      showNotification('Please enter a valid Ethiopian phone number', 'error');
      document.getElementById('customerPhone').focus();
      return;
    }

    // Show loading state
    const button = this;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Processing...';
    button.disabled = true;

    const orderData = {
      customer_name: document.getElementById('customerName').value || 'Walk-in Customer',
      customer_phone: document.getElementById('customerPhone').value || '',
      discount: 0, // No discount
      taxable: true, // Always apply tax
      payment_type: document.getElementById('paymentType').value
    };

    console.log('Order data:', orderData); // Debug log

    // Use XMLHttpRequest to avoid fetch context issues
    const xhr = new XMLHttpRequest();
    xhr.open('POST', '{% url "complete_order" %}', true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

    // Set timeout (30 seconds)
    xhr.timeout = 30000;

    xhr.ontimeout = function () {
      console.error('Request timeout');
      showNotification('Request timed out. Please try again.', 'error');
    };

    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        try {
          console.log('Complete order response status:', xhr.status);
          console.log('Complete order response headers:', xhr.getAllResponseHeaders());
          console.log('Complete order response text:', xhr.responseText);

          if (xhr.status === 200) {
            // Check if response is empty
            if (!xhr.responseText || xhr.responseText.trim() === '') {
              console.error('Empty response from server');
              showNotification('Server returned empty response', 'error');
              return;
            }

            // Check content type
            const contentType = xhr.getResponseHeader('Content-Type');
            console.log('Response Content-Type:', contentType);

            if (contentType && !contentType.includes('application/json')) {
              console.warn('Response is not JSON:', contentType);
              console.log('Non-JSON response:', xhr.responseText.substring(0, 500));
              showNotification('Server returned non-JSON response. Check console for details.', 'error');
              return;
            }

            // Try to parse JSON with better error handling
            let data;
            try {
              data = JSON.parse(xhr.responseText);
            } catch (parseError) {
              console.error('JSON parse error:', parseError);
              console.error('Response text that failed to parse:', xhr.responseText);
              showNotification('Invalid response format from server', 'error');
              return;
            }

            console.log('Parsed order completion data:', data);

            // Check for success in multiple ways
            const isSuccess = data.success === true ||
              data.success === 'true' ||
              (data.transaction_id && data.receipt_id) ||
              data.message === 'Order completed successfully';

            console.log('Order success check:', {
              'data.success': data.success,
              'has transaction_id': !!data.transaction_id,
              'has receipt_id': !!data.receipt_id,
              'message': data.message,
              'isSuccess': isSuccess
            });

            if (isSuccess) {
              // Clear cart
              cart = { items: [], total: 0 };
              updateCartDisplay();

              // Show success message and receipt
              let successMessage = 'Order completed successfully!';
              if (currentTicketNumber) {
                successMessage = `Order completed successfully! Ticket #${currentTicketNumber} has been processed.`;
              }
              showNotification(successMessage, 'success');

              // Store receipt data for modal
              window.currentReceipt = data.receipt || data;

              // Show order success modal
              const orderSuccessModalElement = document.getElementById('orderSuccessModal');
              if (orderSuccessModalElement) {
                const orderSuccessModal = new bootstrap.Modal(orderSuccessModalElement);

                // Populate order success modal with receipt data
                const receiptNumberElement = document.getElementById('receiptNumber');
                const orderTotalElement = document.getElementById('orderTotal');

                if (receiptNumberElement) {
                  receiptNumberElement.textContent = data.receipt?.receipt_number || `R${data.receipt_id || 'Unknown'}`;
                }
                if (orderTotalElement) {
                  orderTotalElement.textContent = parseFloat(data.total_amount || 0).toFixed(2);
                }

                orderSuccessModal.show();
              } else {
                console.error('Order success modal not found');
                showNotification('Order completed successfully! Receipt created.', 'success');
              }

              // Clear form
              document.getElementById('customerName').value = '';
              document.getElementById('customerPhone').value = '';
              document.getElementById('paymentType').value = 'cash';
              updateTotals();
            } else {
              showNotification(data.error || 'Error completing order', 'error');
              // Restore button state
              button.innerHTML = originalText;
              button.disabled = false;
            }
          } else {
            console.error('HTTP error! status:', xhr.status);
            showNotification(`Error completing order: HTTP ${xhr.status}`, 'error');
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
          }
        } catch (error) {
          console.error('Response parsing error:', error);
          showNotification('Error processing server response', 'error');
          // Restore button state
          button.innerHTML = originalText;
          button.disabled = false;
        }
      }
    };

    xhr.onerror = function () {
      console.error('Network error');
      showNotification('Network error. Please check your connection.', 'error');
      // Restore button state
      button.innerHTML = originalText;
      button.disabled = false;
    };

    xhr.ontimeout = function () {
      console.error('Request timeout');
      showNotification('Request timed out. Please try again.', 'error');
      // Restore button state
      button.innerHTML = originalText;
      button.disabled = false;
    };

    try {
      xhr.send(JSON.stringify(orderData));
    } catch (error) {
      console.error('Request send error:', error);
      showNotification('Error sending request: ' + error.message, 'error');
      // Restore button state
      button.innerHTML = originalText;
      button.disabled = false;
    }
  });

  // Show order success modal
  function showOrderSuccessModal(orderData) {
    document.getElementById('receiptNumber').textContent = orderData.receipt_id;
    document.getElementById('orderTotal').textContent = orderData.total_amount.toFixed(2);

    // Store receipt data for actions
    window.currentReceipt = {
      id: orderData.receipt_id,
      pdfUrl: orderData.receipt_pdf_url,
      viewUrl: orderData.receipt_url
    };

    // Clear cart display
    cart = { items: [], total: 0 };
    updateCartDisplay();

    // Show modal
    new bootstrap.Modal(document.getElementById('orderSuccessModal')).show();
  }

  // Download receipt
  document.getElementById('downloadReceiptBtn').addEventListener('click', function () {
    if (window.currentReceipt && window.currentReceipt.id) {
      window.open(`/stores/receipt/${window.currentReceipt.id}/pdf/`, '_blank');
    } else {
      showNotification('Receipt data not available', 'error');
    }
  });

  // Email receipt
  document.getElementById('emailReceiptBtn').addEventListener('click', function () {
    new bootstrap.Modal(document.getElementById('emailModal')).show();
  });

  // Send email
  document.getElementById('sendEmailBtn').addEventListener('click', function () {
    const email = document.getElementById('customerEmail').value.trim();
    const statusDiv = document.getElementById('emailStatus');

    if (!email) {
      statusDiv.className = 'alert alert-danger';
      statusDiv.textContent = 'Please enter an email address';
      statusDiv.style.display = 'block';
      return;
    }

    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) {
      statusDiv.className = 'alert alert-danger';
      statusDiv.textContent = 'Please enter a valid email address';
      statusDiv.style.display = 'block';
      return;
    }

    // Show loading
    const sendBtn = this; // Store reference to button
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Sending...';
    statusDiv.style.display = 'none';

    // Use XMLHttpRequest to avoid fetch context issues (consistent with other AJAX calls)
    const xhr = new XMLHttpRequest();
    xhr.open('POST', `/stores/receipt/${window.currentReceipt.id}/email/`, true);
    xhr.setRequestHeader('Content-Type', 'application/json');
    xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

    // Set timeout (30 seconds)
    xhr.timeout = 30000;

    xhr.ontimeout = function () {
      console.error('Email request timeout');
      statusDiv.className = 'alert alert-danger';
      statusDiv.textContent = 'Request timed out. Please try again.';
      statusDiv.style.display = 'block';
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="bi bi-send me-2"></i>Send Receipt';
    };

    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        try {
          console.log('Email response status:', xhr.status);
          console.log('Email response text:', xhr.responseText);

          if (xhr.status === 200) {
            const data = JSON.parse(xhr.responseText);
            console.log('Email response data:', data);

            if (data.success) {
              statusDiv.className = 'alert alert-success';
              statusDiv.textContent = data.message;
              statusDiv.style.display = 'block';
              document.getElementById('customerEmail').value = '';

              // Close modal after 2 seconds
              setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('emailModal')).hide();
              }, 2000);
            } else {
              statusDiv.className = 'alert alert-danger';
              statusDiv.textContent = data.error || data.message || 'Unknown error occurred';
              statusDiv.style.display = 'block';
            }
          } else {
            // Handle HTTP error responses
            let errorMessage = `HTTP ${xhr.status}`;
            try {
              const errorData = JSON.parse(xhr.responseText);
              errorMessage = errorData.error || errorData.message || errorMessage;
            } catch (e) {
              errorMessage = xhr.responseText || errorMessage;
            }

            console.error('Email HTTP error:', errorMessage);
            statusDiv.className = 'alert alert-danger';
            statusDiv.textContent = `Failed to send email: ${errorMessage}`;
            statusDiv.style.display = 'block';
          }
        } catch (error) {
          console.error('Email response parsing error:', error);
          statusDiv.className = 'alert alert-danger';
          statusDiv.textContent = 'Error processing server response. Please try again.';
          statusDiv.style.display = 'block';
        }

        // Re-enable button
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="bi bi-send me-2"></i>Send Receipt';
      }
    };

    xhr.onerror = function () {
      console.error('Email network error');
      statusDiv.className = 'alert alert-danger';
      statusDiv.textContent = 'Network error. Please check your connection and try again.';
      statusDiv.style.display = 'block';
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="bi bi-send me-2"></i>Send Receipt';
    };

    // Send the request
    try {
      xhr.send(JSON.stringify({ email: email }));
    } catch (error) {
      console.error('Email send error:', error);
      statusDiv.className = 'alert alert-danger';
      statusDiv.textContent = 'Failed to send request. Please try again.';
      statusDiv.style.display = 'block';
      sendBtn.disabled = false;
      sendBtn.innerHTML = '<i class="bi bi-send me-2"></i>Send Receipt';
    }
  });

  // Order button
  document.getElementById('newOrderBtn').addEventListener('click', function () {
    bootstrap.Modal.getInstance(document.getElementById('orderSuccessModal')).hide();

    // Reset everything for new order
    cart = { items: [], total: 0 };
    currentTicketNumber = null;

    // Reset form
    document.getElementById('customerName').value = '';
    document.getElementById('customerPhone').value = '';
    document.getElementById('paymentType').value = 'cash';

    // Reset page header to default
    const headerElement = document.querySelector('.ezm-card-header h3');
    if (headerElement) {
      headerElement.innerHTML = '<i class="bi bi-cart-plus me-2" style="color: #66FCF1;"></i>Point of Sale';
    }

    // Clear any localStorage data
    localStorage.removeItem('pos_cart_data');
    localStorage.removeItem('pos_customer_info');

    // Update display
    updateCartDisplay();
    updateTotals();

    showNotification('Ready for new order', 'info');
  });

  // Clear cart
  document.getElementById('clearCart').addEventListener('click', function () {
    let confirmMessage = 'Are you sure you want to clear the cart?';
    if (currentTicketNumber) {
      confirmMessage = `Are you sure you want to clear the cart?\n\nThis will cancel processing of ticket #${currentTicketNumber}.`;
    }

    if (confirm(confirmMessage)) {
      cart = { items: [], total: 0 };
      currentTicketNumber = null;

      // Reset page header
      const headerElement = document.querySelector('.ezm-card-header h3');
      if (headerElement) {
        headerElement.innerHTML = '<i class="bi bi-cart-plus me-2" style="color: #66FCF1;"></i>Point of Sale';
      }

      // Clear localStorage
      localStorage.removeItem('pos_cart_data');
      localStorage.removeItem('pos_customer_info');

      updateCartDisplay();
      updateTotals();

      showNotification('Cart cleared', 'info');
    }
  });



  // Save cart to Django session (synchronous)
  function saveCartToSession() {
    try {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '{% url "save_cart_to_session" %}', false); // Synchronous
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

      xhr.send(JSON.stringify({
        cart: cart
      }));

      if (xhr.status === 200) {
        console.log('Cart saved to Django session successfully');
        return true;
      } else {
        console.error('Failed to save cart to session:', xhr.status, xhr.responseText);
        return false;
      }
    } catch (error) {
      console.error('Error saving cart to session:', error);
      return false;
    }
  }

  // Save ticket info to Django session (synchronous)
  function saveTicketInfoToSession(ticketInfo) {
    try {
      const xhr = new XMLHttpRequest();
      xhr.open('POST', '{% url "save_ticket_info_to_session" %}', false); // Synchronous
      xhr.setRequestHeader('Content-Type', 'application/json');
      xhr.setRequestHeader('X-CSRFToken', getCookie('csrftoken'));

      xhr.send(JSON.stringify({
        ticket_info: {
          from_ticket: true,
          ticket_id: ticketInfo.ticket_id,
          ticket_number: ticketInfo.ticket_number,
          customer_name: ticketInfo.customer_name,
          customer_phone: ticketInfo.customer_phone
        }
      }));

      if (xhr.status === 200) {
        console.log('Ticket info saved to Django session successfully');
        return true;
      } else {
        console.error('Failed to save ticket info to session:', xhr.status, xhr.responseText);
        return false;
      }
    } catch (error) {
      console.error('Error saving ticket info to session:', error);
      return false;
    }
  }

  // Utility functions are defined above


</script>
{% endblock %}