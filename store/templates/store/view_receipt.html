{% extends 'base_sidebar.html' %}
{% load static %}

{% block title %}Receipt #{{ receipt.id }} - EZM Trade Management{% endblock %}

{% block sidebar_menu %}
{% include 'sidebar_navigation.html' %}
{% endblock %}

{% block extra_css %}
<style>
  /* Define CSS variables for receipt styling */
  :root {
    --accent-teal: #45a29e;
    --accent-cyan: #66fcf1;
    --text-primary: #0b0c10;
    --text-secondary: #1f2833;
    --white: #ffffff;
    --secondary-dark: #1f2833;
    --primary-dark: #0b0c10;
  }

  /* EZM Card Styling */
  .ezm-card {
    background: var(--white);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: none;
  }

  /* Button Styling */
  .btn-ezm-primary {
    background: linear-gradient(45deg, var(--accent-teal), var(--accent-cyan));
    border: none;
    color: var(--white);
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
  }

  .btn-ezm-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(69, 162, 158, 0.4);
    color: var(--white);
    text-decoration: none;
  }

  .btn-ezm-secondary {
    background: var(--secondary-dark);
    border: none;
    color: var(--white);
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s ease;
  }

  .btn-ezm-secondary:hover {
    background: var(--primary-dark);
    color: var(--white);
    text-decoration: none;
  }

  /* Receipt specific styling */
  .receipt-info {
    line-height: 1.6;
  }

  .table {
    margin-bottom: 0;
  }

  .table th {
    background-color: #f8f9fa;
    border-top: none;
    font-weight: 600;
    color: var(--text-primary);
  }

  .table td {
    color: var(--text-secondary);
  }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Breadcrumb -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'initiate_order' %}">Point of Sale</a></li>
      <li class="breadcrumb-item"><a href="{% url 'cashier_transactions' %}">Transaction Details</a></li>
      <li class="breadcrumb-item active" aria-current="page">Receipt #{{ receipt.id }}</li>
    </ol>
  </nav>

  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="ezm-card">
        <div class="d-flex justify-content-between align-items-center p-4">
          <div>
            <h2 class="mb-1" style="color: var(--text-primary);">Receipt #{{ receipt.id }}</h2>
            <p class="text-muted mb-0">Transaction ID: {{ transaction.id }}</p>
          </div>
          <div>
            <a href="{% url 'generate_receipt_pdf' receipt.id %}" class="btn btn-ezm-primary me-2">
              <i class="bi bi-download me-2"></i>Download PDF
            </a>
            <a href="{% url 'cashier_transactions' %}" class="btn btn-ezm-secondary">
              <i class="bi bi-arrow-left me-2"></i>Back to Transactions
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Receipt Content -->
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="ezm-card">
        <div class="p-5">
          <!-- Store Header -->
          <div class="text-center mb-4">
            <h3 class="fw-bold" style="color: var(--accent-teal);">{{ store.name }}</h3>
            <p class="mb-1" style="color: var(--text-secondary);">{{ store.address }}</p>
            <p class="mb-0" style="color: var(--text-secondary);">Phone: {{ store.phone_number }}</p>
            <hr class="my-4" style="border-color: var(--accent-cyan);">
          </div>

          <!-- Receipt Info -->
          <div class="row mb-4">
            <div class="col-6">
              <div class="receipt-info">
                <strong style="color: var(--text-primary);">Receipt #:</strong> <span
                  style="color: var(--text-secondary);">{{ receipt.id }}</span><br>
                <strong style="color: var(--text-primary);">Order ID:</strong> <span
                  style="color: var(--text-secondary);">{{ transaction.id }}</span><br>
                <strong style="color: var(--text-primary);">Date:</strong> <span
                  style="color: var(--text-secondary);">{{ transaction.timestamp|date:"M d, Y" }}</span><br>
                <strong style="color: var(--text-primary);">Time:</strong> <span
                  style="color: var(--text-secondary);">{{ transaction.timestamp|date:"g:i A" }}</span>
              </div>
            </div>
            <div class="col-6 text-end">
              <div class="receipt-info">
                <strong style="color: var(--text-primary);">Salesperson:</strong> <span
                  style="color: var(--text-secondary);">{{ request.user.get_full_name|default:request.user.username }}</span><br>
                <strong style="color: var(--text-primary);">Customer:</strong> <span
                  style="color: var(--text-secondary);">{{ customer_name|default:"Walk-in Customer" }}</span><br>
                {% if customer_phone %}
                <strong style="color: var(--text-primary);">Phone:</strong> <span
                  style="color: var(--text-secondary);">{{ customer_phone }}</span><br>
                {% endif %}
                <strong style="color: var(--text-primary);">Payment:</strong> <span
                  style="color: var(--text-secondary);">{{ transaction.get_payment_type_display }}</span>
              </div>
            </div>
          </div>

          <!-- Items Table -->
          <div class="table-responsive mb-4">
            <table class="table table-borderless">
              <thead style="border-bottom: 2px solid var(--accent-cyan);">
                <tr>
                  <th style="color: var(--text-primary);">Product</th>
                  <th class="text-center" style="color: var(--text-primary);">Quantity</th>
                  <th class="text-end" style="color: var(--text-primary);">Unit Price</th>
                  <th class="text-end" style="color: var(--text-primary);">Total</th>
                </tr>
              </thead>
              <tbody>
                {% for item in order_items %}
                <tr>
                  <td>
                    <strong style="color: var(--text-primary);">{{ item.product.name|default:"Product" }}</strong>
                  </td>
                  <td class="text-center" style="color: var(--text-secondary);">{{ item.quantity }}</td>
                  <td class="text-end" style="color: var(--text-secondary);">ETB {{ item.price_at_time_of_sale|floatformat:2 }}</td>
                  <td class="text-end"><strong style="color: var(--accent-teal);">ETB {{ item.subtotal|floatformat:2 }}</strong></td>
                </tr>
                {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted">No items found</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Totals -->
          <div class="row">
            <div class="col-6"></div>
            <div class="col-6">
              <table class="table table-borderless">
                <tr>
                  <td style="color: var(--text-primary);">Subtotal:</td>
                  <td class="text-end" style="color: var(--text-secondary);">ETB {{ receipt.subtotal|floatformat:2 }}</td>
                </tr>
                {% if receipt.discount_amount and receipt.discount_amount > 0 %}
                <tr>
                  <td style="color: var(--text-primary);">Discount ({{ receipt.discount_percent|floatformat:1 }}%):</td>
                  <td class="text-end" style="color: var(--text-secondary);">-ETB {{ receipt.discount_amount|floatformat:2 }}</td>
                </tr>
                {% endif %}
                {% if receipt.tax_amount and receipt.tax_amount > 0 %}
                <tr>
                  <td style="color: var(--text-primary);">Tax (15%):</td>
                  <td class="text-end" style="color: var(--text-secondary);">ETB {{ receipt.tax_amount|floatformat:2 }}</td>
                </tr>
                {% endif %}
                <tr style="border-top: 2px solid var(--accent-cyan);">
                  <td><strong style="color: var(--text-primary);">Total Paid:</strong></td>
                  <td class="text-end"><strong style="color: var(--accent-teal); font-size: 1.1em;">ETB {{ receipt.total_amount|floatformat:2 }}</strong></td>
                </tr>
                <tr>
                  <td><strong style="color: var(--text-primary);">Payment Method:</strong></td>
                  <td class="text-end"><strong style="color: var(--accent-teal);">{{ transaction.get_payment_type_display }}</strong></td>
                </tr>
              </table>
            </div>
          </div>

          <!-- Footer -->
          <div class="text-center mt-5 pt-4" style="border-top: 1px solid var(--accent-cyan);">
            <p class="mb-1"><strong style="color: var(--accent-teal);">Thank you for your business!</strong></p>
            <p class="small mb-0" style="color: var(--text-secondary);">
              For any inquiries, please contact us at {{ store.phone_number }}
            </p>
            <p class="small" style="color: var(--text-secondary);">
              This receipt was generated on {{ receipt.timestamp|date:"M d, Y g:i A" }}
            </p>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="text-center mt-4">
        <button class="btn btn-ezm-secondary me-2" onclick="window.print()">
          <i class="bi bi-printer me-2"></i>Print Receipt
        </button>
        <a href="{% url 'generate_receipt_pdf' receipt.id %}" class="btn btn-ezm-secondary me-2" target="_blank">
          <i class="bi bi-download me-2"></i>Download PDF
        </a>
        <a href="{% url 'cashier_transactions' %}" class="btn btn-ezm-primary me-2">
          <i class="bi bi-list me-2"></i>Back to Transactions
        </a>
        <a href="{% url 'initiate_order' %}" class="btn btn-ezm-primary">
          <i class="bi bi-plus-circle me-2"></i>New Order
        </a>
      </div>
    </div>
  </div>
</div>

<style>
  /* EZM Receipt Styling */
  .receipt-info {
    line-height: 1.6;
  }

  /* Print Styles */
  @media print {

    .btn-ezm-primary,
    .btn-ezm-secondary,
    .navbar,
    .sidebar,
    .breadcrumb,
    .container-fluid>.row:first-child {
      display: none !important;
    }

    .ezm-card {
      border: none !important;
      box-shadow: none !important;
      background: white !important;
    }

    .container-fluid {
      max-width: 100% !important;
      padding: 0 !important;
    }

    body {
      background: white !important;
      color: black !important;
    }

    /* Override EZM colors for print */
    * {
      color: black !important;
      background: white !important;
    }

    .table th,
    .table td {
      border-color: #000 !important;
    }

    hr {
      border-color: #000 !important;
    }
  }

  /* Receipt specific styling */
  .receipt-item {
    border-bottom: 1px dashed var(--border-color);
    padding: 8px 0;
  }

  .receipt-item:last-child {
    border-bottom: none;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .ezm-card .p-5 {
      padding: 1.5rem !important;
    }

    .btn-ezm-primary,
    .btn-ezm-secondary {
      margin-bottom: 0.5rem;
      width: 100%;
    }
  }
</style>

<script>
  // Receipt page functionality
  document.addEventListener('DOMContentLoaded', function () {
    // Auto-print functionality if print parameter is present
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('print') === 'true') {
      setTimeout(() => {
        window.print();
      }, 500);
    }

    // Add keyboard shortcuts
    document.addEventListener('keydown', function (e) {
      // Ctrl+P for print
      if (e.ctrlKey && e.key === 'p') {
        e.preventDefault();
        window.print();
      }

      // Escape to go back to transactions
      if (e.key === 'Escape') {
        window.location.href = "{% url 'cashier_transactions' %}";
      }
    });

    // Add smooth scrolling for better UX
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth'
          });
        }
      });
    });
  });

  // Print function with better formatting
  function printReceipt() {
    // Add print-specific class before printing
    document.body.classList.add('printing');

    window.print();

    // Remove print class after printing
    setTimeout(() => {
      document.body.classList.remove('printing');
    }, 1000);
  }
</script>
{% endblock %}