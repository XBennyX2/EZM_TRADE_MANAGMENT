{% extends 'base_sidebar.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Edit Profile{% endblock %}
{% block page_title %}Edit Profile{% endblock %}

{% block sidebar_menu %}
{% include 'sidebar_navigation.html' %}
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="ezm-card">
                <div class="ezm-card-header">
                    <i class="bi bi-person-circle me-2"></i>Edit Profile
                </div>
                <div class="card-body">
                    <p class="mb-0">Update your personal information and contact details.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Form -->
    <div class="row">
        <div class="col-lg-8 col-md-10 mx-auto">
            <div class="ezm-card">
                <div class="ezm-card-header">
                    <i class="bi bi-pencil-square me-2"></i>Profile Information
                </div>
                <div class="card-body p-4">
                    <form method="post">
                        {% csrf_token %}

                        {% for field in form %}
                        <div class="mb-3">
                            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                            {{ field|attr:"class:form-control" }}
                            {% if field.help_text %}
                            <small class="text-muted">{{ field.help_text }}</small>
                            {% endif %}
                            {% if field.errors %}
                            <div class="text-danger mt-1">
                                {% for error in field.errors %}
                                <small>{{ error }}</small>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}

                        <div class="d-flex gap-3 mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle me-2"></i>Update Profile
                            </button>
                            <a href="{% if user.is_superuser or user.role == 'admin' %}{% url 'admin_settings' %}{% elif user.role == 'head_manager' %}{% url 'head_manager_settings' %}{% elif user.role == 'store_manager' %}{% url 'store_manager_settings' %}{% elif user.role == 'cashier' %}{% url 'cashier_settings' %}{% else %}{% url 'login' %}{% endif %}"
                               class="btn btn-secondary">
                                <i class="bi bi-arrow-left me-2"></i>Back to Settings
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Phone number validation
        const phoneField = document.querySelector('input[name="phone_number"]');

        if (phoneField) {
            // Create validation message element
            const validationMessage = document.createElement('div');
            validationMessage.className = 'phone-validation-message mt-1';
            validationMessage.style.fontSize = '0.875rem';
            phoneField.parentNode.appendChild(validationMessage);

            function validatePhoneNumber(phoneNumber) {
                // Remove all spaces and special characters except +
                const cleanPhone = phoneNumber.replace(/[\s\-\(\)]/g, '');

                // Ethiopian phone number patterns
                const patterns = [
                    /^09\d{8}$/,           // 09xxxxxxxx (10 digits total)
                    /^07\d{8}$/,           // 07xxxxxxxx (10 digits total)
                    /^\+2519\d{8}$/,       // +2519xxxxxxxx (international format)
                    /^\+2517\d{8}$/        // +2517xxxxxxxx (international format)
                ];

                return patterns.some(pattern => pattern.test(cleanPhone));
            }

            function updateValidationUI(isValid, message) {
                if (isValid) {
                    phoneField.classList.remove('is-invalid');
                    phoneField.classList.add('is-valid');
                    phoneField.style.borderColor = '#28a745';
                    validationMessage.innerHTML = `<small class="text-success"><i class="bi bi-check-circle me-1"></i>${message}</small>`;
                } else {
                    phoneField.classList.remove('is-valid');
                    phoneField.classList.add('is-invalid');
                    phoneField.style.borderColor = '#dc3545';
                    validationMessage.innerHTML = `<small class="text-danger"><i class="bi bi-exclamation-circle me-1"></i>${message}</small>`;
                }
            }

            function validatePhone() {
                const phoneValue = phoneField.value.trim();

                if (phoneValue === '') {
                    // Reset validation state for empty field
                    phoneField.classList.remove('is-valid', 'is-invalid');
                    phoneField.style.borderColor = '';
                    validationMessage.innerHTML = '<small class="text-muted">Enter Ethiopian phone number (09xxxxxxxx, 07xxxxxxxx, or +2519xxxxxxxx)</small>';
                    return;
                }

                if (validatePhoneNumber(phoneValue)) {
                    updateValidationUI(true, 'Valid Ethiopian phone number');
                } else {
                    let errorMessage = 'Invalid phone number format. ';

                    // Provide specific guidance based on input
                    if (phoneValue.startsWith('+251')) {
                        errorMessage += 'Use +2519xxxxxxxx or +2517xxxxxxxx format';
                    } else if (phoneValue.startsWith('0')) {
                        errorMessage += 'Use 09xxxxxxxx or 07xxxxxxxx format (10 digits total)';
                    } else if (phoneValue.startsWith('9') || phoneValue.startsWith('7')) {
                        errorMessage += 'Add leading 0 (09xxxxxxxx or 07xxxxxxxx)';
                    } else {
                        errorMessage += 'Use 09xxxxxxxx, 07xxxxxxxx, or +2519xxxxxxxx format';
                    }

                    updateValidationUI(false, errorMessage);
                }
            }

            // Add event listeners
            phoneField.addEventListener('input', validatePhone);
            phoneField.addEventListener('blur', validatePhone);

            // Initial validation if field has value
            if (phoneField.value.trim()) {
                validatePhone();
            } else {
                validationMessage.innerHTML = '<small class="text-muted">Enter Ethiopian phone number (09xxxxxxxx, 07xxxxxxxx, or +2519xxxxxxxx)</small>';
            }

            // Format phone number as user types (optional enhancement)
            phoneField.addEventListener('input', function(e) {
                let value = e.target.value.replace(/[\s\-\(\)]/g, ''); // Remove formatting

                // Auto-format for better UX
                if (value.startsWith('09') && value.length <= 10) {
                    // Format as 09X XXX XXXX
                    if (value.length > 3) {
                        value = value.substring(0, 3) + ' ' + value.substring(3);
                    }
                    if (value.length > 7) {
                        value = value.substring(0, 7) + ' ' + value.substring(7);
                    }
                } else if (value.startsWith('07') && value.length <= 10) {
                    // Format as 07X XXX XXXX
                    if (value.length > 3) {
                        value = value.substring(0, 3) + ' ' + value.substring(3);
                    }
                    if (value.length > 7) {
                        value = value.substring(0, 7) + ' ' + value.substring(7);
                    }
                } else if (value.startsWith('+2519') && value.length <= 13) {
                    // Format as +251 9X XXX XXXX
                    if (value.length > 4) {
                        value = value.substring(0, 4) + ' ' + value.substring(4);
                    }
                    if (value.length > 8) {
                        value = value.substring(0, 8) + ' ' + value.substring(8);
                    }
                    if (value.length > 12) {
                        value = value.substring(0, 12) + ' ' + value.substring(12);
                    }
                }

                // Update field value with formatting
                if (e.target.value !== value) {
                    const cursorPos = e.target.selectionStart;
                    e.target.value = value;
                    // Restore cursor position
                    e.target.setSelectionRange(cursorPos, cursorPos);
                }
            });
        }

        // Form submission validation
        const form = document.querySelector('form');
        if (form && phoneField) {
            form.addEventListener('submit', function(e) {
                const phoneValue = phoneField.value.trim();
                if (phoneValue && !validatePhoneNumber(phoneValue)) {
                    e.preventDefault();
                    phoneField.focus();
                    updateValidationUI(false, 'Please enter a valid Ethiopian phone number before submitting');

                    // Show alert
                    alert('Please enter a valid Ethiopian phone number format:\n• 09xxxxxxxx (10 digits)\n• 07xxxxxxxx (10 digits)\n• +2519xxxxxxxx\n• +2517xxxxxxxx');
                }
            });
        }
    });
</script>

<style>
    .phone-validation-message {
        min-height: 20px;
    }

    .is-valid {
        border-color: #28a745 !important;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
    }

    .is-invalid {
        border-color: #dc3545 !important;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
    }
</style>
{% endblock %}