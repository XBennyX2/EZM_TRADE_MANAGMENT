{% extends 'base.html' %}

{% block content %}
<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
  .cashier-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: none;
    border-radius: 0.75rem;
    box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.05);
  }

  .cashier-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.1);
  }

  .cashier-header {
    background: linear-gradient(90deg, #6f42c1, #e83e8c);
    color: white;
    border-radius: 0.75rem 0.75rem 0 0;
    padding: 1rem 1.5rem;
  }

  .cashier-item {
    border: 1px solid #e9ecef;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.2s ease;
  }

  .cashier-item:hover {
    border-color: #6f42c1;
    box-shadow: 0 0.25rem 0.5rem rgba(111, 66, 193, 0.1);
  }

  .cashier-item.active {
    border-color: #28a745;
    background-color: #f8fff9;
  }

  .cashier-item.inactive {
    border-color: #dc3545;
    background-color: #fff5f5;
  }

  .available-cashier {
    border: 1px solid #17a2b8;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
    background-color: #f0f9ff;
  }

  .search-highlight {
    background-color: #fff3cd;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
  }

  .pagination .page-link {
    color: #6f42c1;
  }

  .pagination .page-item.active .page-link {
    background-color: #6f42c1;
    border-color: #6f42c1;
  }

  .pagination .page-link:hover {
    color: #5a2d91;
    background-color: #f8f9fa;
  }

  #messages-container {
    position: sticky;
    top: 20px;
    z-index: 1050;
  }

  .alert {
    border-radius: 0.75rem;
    box-shadow: 0 0.25rem 1rem rgba(0, 0, 0, 0.1);
  }

  .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>

<div class="container mt-4">
  <!-- CSRF Token -->
  {% csrf_token %}

  <!-- Messages Container -->
  <div id="messages-container"></div>

  <!-- Header -->
  <div class="cashier-card mb-4">
    <div class="cashier-header">
      <h3 class="mb-0"><i class="bi bi-people"></i> Cashier Management - {{ manager_store.name }}</h3>
    </div>
    <div class="card-body">
      <p class="mb-0">Manage cashiers assigned to your store. You can assign new cashiers and activate/deactivate existing ones.</p>
    </div>
  </div>

  <!-- Navigation Tabs -->
  <ul class="nav nav-tabs mb-4" id="cashierTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="assigned-tab" data-bs-toggle="tab" data-bs-target="#assigned" type="button" role="tab">
        <i class="bi bi-person-check"></i> Assigned Cashiers
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="available-tab" data-bs-toggle="tab" data-bs-target="#available" type="button" role="tab">
        <i class="bi bi-person-plus"></i> Available Cashiers
      </button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content" id="cashierTabsContent">
    <!-- Assigned Cashiers Tab -->
    <div class="tab-pane fade show active" id="assigned" role="tabpanel">
      <div class="card cashier-card">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="bi bi-person-check"></i> Currently Assigned Cashiers</h5>
        </div>
        <div class="card-body">
          {% if store_cashiers %}
          <p class="text-muted mb-3">
            <i class="bi bi-info-circle"></i>
            <strong>Note:</strong> Only one cashier can be active at a time. Deactivate the current active cashier before activating another.
          </p>
          {% for assignment in store_cashiers %}
          <div class="cashier-item {% if assignment.is_active %}active{% else %}inactive{% endif %}">
            <div class="row align-items-center">
              <div class="col-md-3">
                <div class="d-flex align-items-center">
                  {% if assignment.is_active %}
                    <i class="bi bi-person-check-fill display-6 text-success me-3"></i>
                  {% else %}
                    <i class="bi bi-person-circle display-6 text-muted me-3"></i>
                  {% endif %}
                  <div>
                    <h6 class="mb-0">
                      {{ assignment.cashier.username }}
                      {% if assignment.is_active %}
                        <i class="bi bi-star-fill text-warning ms-1" title="Active Cashier"></i>
                      {% endif %}
                    </h6>
                    <small class="text-muted">{{ assignment.cashier.first_name }} {{ assignment.cashier.last_name }}</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <small class="text-muted">Email:</small><br>
                <span>{{ assignment.cashier.email|default:"Not provided" }}</span>
              </div>
              <div class="col-md-2">
                <small class="text-muted">Phone:</small><br>
                <span>{{ assignment.cashier.phone_number|default:"Not provided" }}</span>
              </div>
              <div class="col-md-2">
                <small class="text-muted">Status:</small><br>
                {% if assignment.is_active %}
                  <span class="badge bg-success"><i class="bi bi-check-circle"></i> Active</span>
                {% else %}
                  <span class="badge bg-secondary"><i class="bi bi-pause-circle"></i> Inactive</span>
                {% endif %}
              </div>
              <div class="col-md-2 text-end">
                <button type="button"
                        class="btn {% if assignment.is_active %}btn-outline-danger{% else %}btn-outline-success{% endif %} btn-sm toggle-cashier-btn"
                        data-cashier-id="{{ assignment.id }}"
                        data-cashier-name="{{ assignment.cashier.username }}"
                        data-current-status="{{ assignment.is_active|yesno:'true,false' }}"
                        data-url="{% url 'toggle_cashier_status' assignment.id %}">
                  {% if assignment.is_active %}
                    <i class="bi bi-person-x"></i> Deactivate
                  {% else %}
                    <i class="bi bi-person-check"></i> Activate
                  {% endif %}
                </button>
              </div>
            </div>
          </div>
          {% endfor %}
          {% else %}
          <div class="text-center py-4">
            <i class="bi bi-person-x display-1 text-muted"></i>
            <h4 class="text-muted mt-3">No Assigned Cashiers</h4>
            <p class="text-muted">You haven't assigned any cashiers to your store yet.</p>
            <button class="btn btn-primary" data-bs-toggle="tab" data-bs-target="#available">
              <i class="bi bi-person-plus"></i> Assign Cashiers
            </button>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Available Cashiers Tab -->
    <div class="tab-pane fade" id="available" role="tabpanel">
      <div class="card cashier-card">
        <div class="card-header bg-info text-white">
          <h5 class="mb-0"><i class="bi bi-person-plus"></i> Available Cashiers</h5>
        </div>
        <div class="card-body">
          <!-- Search Form -->
          <div class="row mb-4">
            <div class="col-md-8">
              <form method="GET" class="d-flex">
                <input type="text"
                       name="search"
                       class="form-control me-2"
                       placeholder="Search cashiers by name, username, or email..."
                       value="{{ search_query }}"
                       id="cashierSearch">
                <button type="submit" class="btn btn-outline-primary">
                  <i class="bi bi-search"></i> Search
                </button>
                {% if search_query %}
                <a href="{% url 'store_manager_cashier_management' %}" class="btn btn-outline-secondary ms-2">
                  <i class="bi bi-x-circle"></i> Clear
                </a>
                {% endif %}
              </form>
            </div>
            <div class="col-md-4 text-end">
              <small class="text-muted">
                {% if search_query %}
                  Showing results for "{{ search_query }}"
                {% else %}
                  Showing all available cashiers
                {% endif %}
              </small>
            </div>
          </div>

          {% if available_cashiers %}
          <p class="text-muted mb-3">
            <i class="bi bi-info-circle"></i>
            <strong>Note:</strong> Only one cashier can be active per store. Inactive cashiers from other stores can be assigned.
          </p>

          <!-- Cashiers List -->
          {% for cashier in available_cashiers %}
          <div class="available-cashier">
            <div class="row align-items-center">
              <div class="col-md-3">
                <div class="d-flex align-items-center">
                  <i class="bi bi-person-circle display-6 text-info me-3"></i>
                  <div>
                    <h6 class="mb-0">{{ cashier.username }}</h6>
                    <small class="text-muted">{{ cashier.first_name }} {{ cashier.last_name }}</small>
                  </div>
                </div>
              </div>
              <div class="col-md-3">
                <small class="text-muted">Email:</small><br>
                <span>{{ cashier.email|default:"Not provided" }}</span>
              </div>
              <div class="col-md-3">
                <small class="text-muted">Phone:</small><br>
                <span>{{ cashier.phone_number|default:"Not provided" }}</span>
              </div>
              <div class="col-md-3 text-end">
                <button type="button"
                        class="btn btn-success btn-sm assign-cashier-btn"
                        data-cashier-id="{{ cashier.id }}"
                        data-cashier-name="{{ cashier.username }}"
                        data-store-name="{{ manager_store.name }}"
                        data-url="{% url 'assign_cashier_to_store' cashier.id %}">
                  <i class="bi bi-person-plus"></i> Assign to Store
                </button>
              </div>
            </div>
          </div>
          {% endfor %}

          <!-- Pagination -->
          {% if available_cashiers.has_other_pages %}
          <nav aria-label="Available cashiers pagination" class="mt-4">
            <ul class="pagination justify-content-center">
              {% if available_cashiers.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}">
                    <i class="bi bi-chevron-double-left"></i> First
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ available_cashiers.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                    <i class="bi bi-chevron-left"></i> Previous
                  </a>
                </li>
              {% endif %}

              {% for num in available_cashiers.paginator.page_range %}
                {% if available_cashiers.number == num %}
                  <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                  </li>
                {% elif num > available_cashiers.number|add:'-3' and num < available_cashiers.number|add:'3' %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% if search_query %}&search={{ search_query }}{% endif %}">{{ num }}</a>
                  </li>
                {% endif %}
              {% endfor %}

              {% if available_cashiers.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ available_cashiers.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}">
                    Next <i class="bi bi-chevron-right"></i>
                  </a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ available_cashiers.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}">
                    Last <i class="bi bi-chevron-double-right"></i>
                  </a>
                </li>
              {% endif %}
            </ul>
          </nav>

          <!-- Pagination Info -->
          <div class="text-center mt-3">
            <small class="text-muted">
              Showing {{ available_cashiers.start_index }} to {{ available_cashiers.end_index }}
              of {{ available_cashiers.paginator.count }} cashiers
            </small>
          </div>
          {% endif %}

          {% else %}
          <div class="text-center py-4">
            <i class="bi bi-person-plus display-1 text-muted"></i>
            <h4 class="text-muted mt-3">
              {% if search_query %}
                No Cashiers Found
              {% else %}
                No Available Cashiers
              {% endif %}
            </h4>
            <p class="text-muted">
              {% if search_query %}
                No cashiers match your search criteria "{{ search_query }}".
              {% else %}
                All cashiers are currently active in stores or there are no cashier accounts available.
              {% endif %}
            </p>
            {% if search_query %}
            <a href="{% url 'store_manager_cashier_management' %}" class="btn btn-outline-primary">
              <i class="bi bi-arrow-left"></i> View All Cashiers
            </a>
            {% endif %}
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Back Button -->
  <div class="mt-4">
    <a href="{% url 'store_manager_page' %}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Back to Dashboard
    </a>
  </div>
</div>

<script>
// Initialize Bootstrap tabs - both navigation tabs and content buttons
var triggerTabList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tab"]'))
triggerTabList.forEach(function (triggerEl) {
  var tabTrigger = new bootstrap.Tab(triggerEl)
  triggerEl.addEventListener('click', function (event) {
    event.preventDefault()
    tabTrigger.show()

    // Update active state for navigation tabs
    if (triggerEl.getAttribute('data-bs-target') === '#available') {
      document.getElementById('assigned-tab').classList.remove('active')
      document.getElementById('available-tab').classList.add('active')
    } else if (triggerEl.getAttribute('data-bs-target') === '#assigned') {
      document.getElementById('available-tab').classList.remove('active')
      document.getElementById('assigned-tab').classList.add('active')
    }
  })
})

// Function to display messages
function showMessage(message, type) {
  const messagesContainer = document.getElementById('messages-container');
  const alertClass = type === 'success' ? 'alert-success' :
                    type === 'warning' ? 'alert-warning' :
                    type === 'error' ? 'alert-danger' : 'alert-info';

  const alertHtml = `
    <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
      <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'error' ? 'x-circle' : 'info-circle'}"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
  `;

  messagesContainer.innerHTML = alertHtml;

  // Auto-dismiss after 5 seconds
  setTimeout(() => {
    const alert = messagesContainer.querySelector('.alert');
    if (alert) {
      const bsAlert = new bootstrap.Alert(alert);
      bsAlert.close();
    }
  }, 5000);

  // Scroll to top to show message
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Function to get CSRF token
function getCSRFToken() {
  return document.querySelector('[name=csrfmiddlewaretoken]').value;
}

// Handle toggle cashier status
document.addEventListener('click', function(e) {
  if (e.target.closest('.toggle-cashier-btn')) {
    e.preventDefault();
    const button = e.target.closest('.toggle-cashier-btn');
    const cashierName = button.dataset.cashierName;
    const currentStatus = button.dataset.currentStatus === 'true';
    const url = button.dataset.url;

    const action = currentStatus ? 'deactivate' : 'activate';
    const confirmMessage = currentStatus ?
      `Are you sure you want to deactivate ${cashierName}? This will remove their access to the POS system.` :
      `Are you sure you want to activate ${cashierName}? This will make them the active cashier for your store.`;

    if (confirm(confirmMessage)) {
      // Disable button during request
      button.disabled = true;
      button.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';

      fetch(url, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCSRFToken(),
          'Content-Type': 'application/json',
        },
      })
      .then(response => response.json())
      .then(data => {
        showMessage(data.message, data.type);

        if (data.success) {
          // Update button appearance and data
          const newStatus = data.new_status;
          button.dataset.currentStatus = newStatus.toString();

          if (newStatus) {
            button.className = 'btn btn-outline-danger btn-sm toggle-cashier-btn';
            button.innerHTML = '<i class="bi bi-person-x"></i> Deactivate';
          } else {
            button.className = 'btn btn-outline-success btn-sm toggle-cashier-btn';
            button.innerHTML = '<i class="bi bi-person-check"></i> Activate';
          }

          // Update status badge and other visual elements
          const cashierItem = button.closest('.cashier-item');
          const statusBadge = cashierItem.querySelector('.badge');
          const personIcon = cashierItem.querySelector('.bi-person-check-fill, .bi-person-circle');
          const starIcon = cashierItem.querySelector('.bi-star-fill');

          if (newStatus) {
            cashierItem.className = 'cashier-item active';
            statusBadge.className = 'badge bg-success';
            statusBadge.innerHTML = '<i class="bi bi-check-circle"></i> Active';
            personIcon.className = 'bi bi-person-check-fill display-6 text-success me-3';
            if (!starIcon) {
              const username = cashierItem.querySelector('h6');
              username.innerHTML += ' <i class="bi bi-star-fill text-warning ms-1" title="Active Cashier"></i>';
            }
          } else {
            cashierItem.className = 'cashier-item inactive';
            statusBadge.className = 'badge bg-secondary';
            statusBadge.innerHTML = '<i class="bi bi-pause-circle"></i> Inactive';
            personIcon.className = 'bi bi-person-circle display-6 text-muted me-3';
            if (starIcon) {
              starIcon.remove();
            }
          }
        }

        button.disabled = false;
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage('An error occurred. Please try again.', 'error');
        button.disabled = false;

        // Restore original button text
        if (currentStatus) {
          button.innerHTML = '<i class="bi bi-person-x"></i> Deactivate';
        } else {
          button.innerHTML = '<i class="bi bi-person-check"></i> Activate';
        }
      });
    }
  }
});

// Handle assign cashier
document.addEventListener('click', function(e) {
  if (e.target.closest('.assign-cashier-btn')) {
    e.preventDefault();
    const button = e.target.closest('.assign-cashier-btn');
    const cashierName = button.dataset.cashierName;
    const storeName = button.dataset.storeName;
    const url = button.dataset.url;

    const confirmMessage = `Are you sure you want to assign ${cashierName} to ${storeName}? This will make them the active cashier for your store.`;

    if (confirm(confirmMessage)) {
      // Disable button during request
      button.disabled = true;
      button.innerHTML = '<i class="bi bi-hourglass-split"></i> Assigning...';

      fetch(url, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCSRFToken(),
          'Content-Type': 'application/json',
        },
      })
      .then(response => response.json())
      .then(data => {
        showMessage(data.message, data.type);

        if (data.success) {
          // Reload the page to update the cashier lists
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          button.disabled = false;
          button.innerHTML = '<i class="bi bi-person-plus"></i> Assign to Store';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showMessage('An error occurred. Please try again.', 'error');
        button.disabled = false;
        button.innerHTML = '<i class="bi bi-person-plus"></i> Assign to Store';
      });
    }
  }
});
</script>
{% endblock %}
